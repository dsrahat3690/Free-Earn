<?php
session_start();
include 'db.php';

$error = '';
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $name = trim($_POST['name']);
    $email = trim($_POST['email']);
    $mobile = trim($_POST['mobile']);
    $password = $_POST['password'];
    $referral_code = strtoupper(trim($_POST['referral_code']));

    // рж╕рж╣ржЬ ржмрзЗрж╕рж┐ржХ ржнрзНржпрж╛рж▓рж┐ржбрзЗрж╢ржи
    if (!$name || !$email || !$mobile || !$password) {
        $error = "рж╕ржм ржлрж┐рж▓рзНржб ржкрзВрж░ржг ржХрж░рзБржиред";
    } elseif (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
        $error = "рж╕ржарж┐ржХ ржЗржорзЗржЗрж▓ ржжрж┐ржиред";
    } else {
        // ржЪрзЗржХ ржХрж░рзЛ ржЗржорзЗржЗрж▓ ржЖржЧрзЗ ржЖржЫрзЗ ржХрж┐ ржирж╛
        $stmt = $conn->prepare("SELECT id FROM users WHERE email = ?");
        $stmt->bind_param("s", $email);
        $stmt->execute();
        $stmt->store_result();

        if ($stmt->num_rows > 0) {
            $error = "ржПржЗ ржЗржорзЗржЗрж▓ ржжрж┐рзЯрзЗ ржЖржЧрзЗ рж░рзЗржЬрж┐рж╕рзНржЯрж╛рж░ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред";
        } else {
            // рж░рзЗржлрж╛рж░ ржХрзЛржб ржнрзНржпрж╛рж▓рж┐ржбрзЗрж╢ржи (ржРржЪрзНржЫрж┐ржХ)
            $referred_by = null;
            if ($referral_code) {
                $stmt2 = $conn->prepare("SELECT referral_code FROM users WHERE referral_code = ?");
                $stmt2->bind_param("s", $referral_code);
                $stmt2->execute();
                $stmt2->store_result();
                if ($stmt2->num_rows === 0) {
                    $error = "рж░рзЗржлрж╛рж░ ржХрзЛржб рж╕ржарж┐ржХ ржирзЯред";
                } else {
                    $referred_by = $referral_code;
                }
                $stmt2->close();
            }
        }
        $stmt->close();
    }

    if (!$error) {
        $hashed_password = password_hash($password, PASSWORD_DEFAULT);

        // ржирждрзБржи рж░рзЗржлрж╛рж░ ржХрзЛржб рждрзИрж░рж┐ (ржпрзЗржоржи: ржкрзНрж░ржержо 3 ржЕржХрзНрж╖рж░ ржирж╛ржо + ржЗржЙржирж┐ржХ ржиржорзНржмрж░)
        $ref_code = strtoupper(substr($name, 0, 3)) . rand(1000, 9999);

        $stmt3 = $conn->prepare("INSERT INTO users (name, email, mobile, password, referral_code, referred_by, balance) VALUES (?, ?, ?, ?, ?, ?, 0)");
        $stmt3->bind_param("ssssss", $name, $email, $mobile, $hashed_password, $ref_code, $referred_by);
        if ($stmt3->execute()) {
            $_SESSION['user_email'] = $email;
            header("Location: home.php");
            exit();
        } else {
            $error = "рж░рзЗржЬрж┐рж╕рзНржЯрзНрж░рзЗрж╢ржи ржХрж░рждрзЗ рж╕ржорж╕рзНржпрж╛ рж╣рзЯрзЗржЫрзЗред";
        }
        $stmt3->close();
    }
}
?>

<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <title>BD Earn - рж░рзЗржЬрж┐рж╕рзНржЯрзНрж░рзЗрж╢ржи</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h2>ЁЯУЭ рж░рзЗржЬрж┐рж╕рзНржЯрж╛рж░ ржХрж░рзБржи</h2>

    <?php if ($error): ?>
      <p style="color: red; margin-bottom: 15px;"><?php echo $error; ?></p>
    <?php endif; ?>

    <form method="POST" action="">
      <input type="text" name="name" placeholder="ржЖржкржирж╛рж░ ржирж╛ржо" required />
      <input type="email" name="email" placeholder="ржЗржорзЗржЗрж▓" required />
      <input type="text" name="mobile" placeholder="ржорзЛржмрж╛ржЗрж▓ ржиржорзНржмрж░" required />
      <input type="password" name="password" placeholder="ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб" required />
      <input type="text" name="referral_code" placeholder="рж░рзЗржлрж╛рж░ ржХрзЛржб (ржРржЪрзНржЫрж┐ржХ)" />
      <button type="submit">рж░рзЗржЬрж┐рж╕рзНржЯрж╛рж░</button>
    </form>
    <p>ржЖржЧрзЗржЗ ржПржХрж╛ржЙржирзНржЯ ржЖржЫрзЗ? <a href="login.php">рж▓ржЧржЗржи ржХрж░рзБржи</a></p>
  </div>
</body>
</html>
